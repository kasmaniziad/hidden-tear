USE [LDO_DMS]
GO
/****** Object:  Schema [lomo]    Script Date: 1/10/2017 1:59:20 PM ******/
CREATE SCHEMA [lomo]
GO
/****** Object:  UserDefinedFunction [dbo].[AppendParentPath]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

Create Function [dbo].[AppendParentPath]
(
	@parent hierarchyid = null
)
RETURNS varchar(max) AS
Begin       
    Declare @result varchar(max), @newid uniqueidentifier

    SELECT @newid = new_id FROM dbo.getNewID; 

    SELECT @result = ISNULL(@parent.ToString(), '/') +
                     convert(varchar(20), convert(bigint, substring(convert(binary(16), @newid), 1, 6))) + '.' +
                     convert(varchar(20), convert(bigint, substring(convert(binary(16), @newid), 7, 6))) + '.' +
                     convert(varchar(20), convert(bigint, substring(convert(binary(16), @newid), 13, 4))) + '/'     
    RETURN @result 
End


GO
/****** Object:  Table [dbo].[DocumentStore]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ARITHABORT ON
GO
CREATE TABLE [dbo].[DocumentStore] AS FILETABLE ON [PRIMARY] FILESTREAM_ON [LDO_DMS_FL]
WITH
(
FILETABLE_DIRECTORY = N'DocumentStore', FILETABLE_COLLATE_FILENAME = SQL_Latin1_General_CP1_CI_AS
)

GO
/****** Object:  Table [lomo].[LOG_Order_Documents]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [lomo].[LOG_Order_Documents](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[OrderId] [int] NOT NULL,
	[SiteNum] [varchar](10) NOT NULL,
	[CustNum] [varchar](10) NOT NULL,
	[MatchCode] [varchar](15) NOT NULL,
	[CustomerName] [varchar](200) NULL,
	[Category] [varchar](15) NULL,
	[Client] [varchar](50) NULL,
	[DRNumber] [varchar](15) NULL,
	[OrderNum] [varchar](15) NULL,
	[LomCreatedOn] [datetime] NULL,
	[LomCreatedBy] [varchar](15) NULL,
	[Quantity] [real] NULL,
	[ProductId] [int] NULL,
	[Product] [varchar](15) NULL,
	[OrderStatus] [int] NULL,
	[LomModifiedOn] [datetime] NULL,
	[LomModifiedBy] [varchar](15) NULL,
	[TractorNumber] [varchar](10) NULL,
	[TrailorNumber] [varchar](10) NULL,
	[DriverName] [varchar](200) NULL,
	[ShiftId] [smallint] NULL,
	[ShiftDate] [date] NULL,
	[TourEnd] [datetime] NULL,
	[TranNo] [varchar](20) NULL,
	[CreatedOn] [datetime] NOT NULL,
	[CreatedBy] [int] NOT NULL,
 CONSTRAINT [PK_LOG_Order_Documents] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [lomo].[MST_DocCategory]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [lomo].[MST_DocCategory](
	[Id] [tinyint] IDENTITY(1,1) NOT NULL,
	[Description] [nvarchar](100) NULL,
	[isActive] [bit] NOT NULL,
	[CreatedOn] [datetime] NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[ModifiedOn] [datetime] NOT NULL,
	[ModifiedBy] [int] NOT NULL,
 CONSTRAINT [PK_MST_DocCategory] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [lomo].[MST_Month_Folder]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [lomo].[MST_Month_Folder](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[Datum] [date] NOT NULL,
	[FolderPath] [hierarchyid] NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreatedOn] [datetime] NOT NULL,
 CONSTRAINT [PK_MST_Month_Folder] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [lomo].[MST_Order_Documents]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [lomo].[MST_Order_Documents](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[OrderId] [int] NOT NULL,
	[OrderNum] [int] NOT NULL,
	[DRNum] [int] NULL,
	[ResourceId] [uniqueidentifier] NOT NULL,
	[DocCategoryId] [tinyint] NOT NULL,
	[isArchived] [bit] NOT NULL,
	[Remark] [nvarchar](255) NULL,
	[TranNo] [varchar](20) NULL,
	[CreatedOn] [datetime] NOT NULL,
	[CreatedBy] [datetime] NOT NULL,
	[ModifiedOn] [datetime] NOT NULL,
	[ModifiedBy] [datetime] NOT NULL,
 CONSTRAINT [PK_MST_Order_Documents] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [lomo].[MST_Status]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [lomo].[MST_Status](
	[Id] [tinyint] IDENTITY(1,1) NOT NULL,
	[Description] [varchar](20) NOT NULL,
	[isActive] [bit] NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreatedOn] [datetime] NOT NULL,
 CONSTRAINT [PK_MST_Status] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  View [dbo].[getNewID]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create view [dbo].[getNewID] as select newid() as new_id 


GO
ALTER TABLE [lomo].[LOG_Order_Documents] ADD  CONSTRAINT [DF_LOG_Order_Documents_CreatedOn]  DEFAULT (getdate()) FOR [CreatedOn]
GO
ALTER TABLE [lomo].[MST_DocCategory] ADD  CONSTRAINT [DF_MST_DocCategory_isActive]  DEFAULT ((1)) FOR [isActive]
GO
ALTER TABLE [lomo].[MST_DocCategory] ADD  CONSTRAINT [DF_MST_DocCategory_CreatedOn]  DEFAULT (getdate()) FOR [CreatedOn]
GO
ALTER TABLE [lomo].[MST_DocCategory] ADD  CONSTRAINT [DF_MST_DocCategory_ModifiedOn]  DEFAULT (getdate()) FOR [ModifiedOn]
GO
ALTER TABLE [lomo].[MST_Month_Folder] ADD  CONSTRAINT [DF_MST_Month_Folder_CreatedOn]  DEFAULT (getdate()) FOR [CreatedOn]
GO
ALTER TABLE [lomo].[MST_Order_Documents] ADD  CONSTRAINT [DF_MST_Order_Documents_isArchived]  DEFAULT ((0)) FOR [isArchived]
GO
ALTER TABLE [lomo].[MST_Order_Documents] ADD  CONSTRAINT [DF_MST_Order_Documents_CreatedOn]  DEFAULT (getdate()) FOR [CreatedOn]
GO
ALTER TABLE [lomo].[MST_Order_Documents] ADD  CONSTRAINT [DF_MST_Order_Documents_ModifiedOn]  DEFAULT (getdate()) FOR [ModifiedOn]
GO
ALTER TABLE [lomo].[MST_Status] ADD  CONSTRAINT [DF_MST_Status_isActive]  DEFAULT ((1)) FOR [isActive]
GO
ALTER TABLE [lomo].[MST_Status] ADD  CONSTRAINT [DF_MST_Status_CreatedOn]  DEFAULT (getdate()) FOR [CreatedOn]
GO
ALTER TABLE [lomo].[MST_Order_Documents]  WITH CHECK ADD  CONSTRAINT [FK_MST_Order_Documents_MST_DocCategory] FOREIGN KEY([DocCategoryId])
REFERENCES [lomo].[MST_DocCategory] ([Id])
GO
ALTER TABLE [lomo].[MST_Order_Documents] CHECK CONSTRAINT [FK_MST_Order_Documents_MST_DocCategory]
GO
/****** Object:  StoredProcedure [dbo].[AddDR]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

Create Procedure [dbo].[AddDR]
(
	@ResourceId uniqueidentifier,
	@FileExtension varchar(5),
	@OrderDate date,
	@FileData varbinary(max)
)
As
Begin

	Declare @tmp table (folderPath hierarchyid)

	Insert into 
		@tmp (folderPath)
	exec [lomo].[GetFolderPath] @OrderDate


	Declare @UserHierarchyId hierarchyid

	Select
		@UserHierarchyId = a.folderPath
	From
		@tmp a

	Insert into dbo.DocumentStore
		(stream_id, name, path_locator, file_stream)
	Select
		@ResourceId, CONCAT(@ResourceId, @FileExtension), dbo.AppendParentPath(@UserHierarchyId), @FileData

End

GO
/****** Object:  StoredProcedure [dbo].[CreateDirectory]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE Procedure [dbo].[CreateDirectory]
As
Begin

	DECLARE @FirstSeqNum sql_variant,
            @LastSeqNum  sql_variant
 
     EXEC sys.sp_sequence_get_range
     @sequence_name = N'dbo.DirId'
   , @range_size = 1
   , @range_first_value = @FirstSeqNum OUTPUT
   , @range_last_value = @LastSeqNum OUTPUT

	Declare @MainFolderId HIERARCHYID
	Declare @SubDirectoryPath varchar(max)

	SELECT @SubDirectoryPath = CONCAT('/', CONVERT(VARCHAR(20),@FirstSeqNum) ,'.',
    CONVERT(VARCHAR(20),Convert(BIGINT,@FirstSeqNum)) ,'.',
    CONVERT(VARCHAR(20),@LastSeqNum) ,'/')
	
	INSERT INTO dbo.DocumentStore(name,path_locator,is_directory,is_archive)
	output inserted.path_locator as FolderPath
	VALUES (Cast(@FirstSeqNum as nvarchar(max)), @SubDirectoryPath, 1, 0)

End

GO
/****** Object:  StoredProcedure [dbo].[GetFileByStreamId]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [dbo].[GetFileByStreamId]
(
	@streamId uniqueidentifier,
	@LoggedInUserId int
)
As
Begin

	Select
		a.file_stream as FileData, a.name as FileName
	From
		DocumentStore a
	WITH (Readcommittedlock)
	Inner Join
		[lomo].[MST_Order_Documents] b
	On
		a.stream_id = b.ResourceId --and b.CreatedBy = @LoggedInUserId
	Where
		a.stream_id = @streamId --and (b.CreatedBy = @LoggedInUserId or @LoggedInUserId in (Select
																							--	b.UserId
																							--From
																							--	[LDO].[dbo].[UserAction] a
																							--Inner Join
																							--	[LDO].[dbo].[UserRoleModules] b
																							--On
																							--	a.URMId = b.Id
																							--Where
																							--	a.ActionId in (select a.Id from [LDO].[dbo].[Action] a where a.Prefix = 'DRCVL')))


End
GO
/****** Object:  StoredProcedure [lomo].[GetAllClients]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create Procedure [lomo].[GetAllClients]
As
Begin


	Select
		0 as ClientId, 'All' as ClientName

	union all

	Select
		a.id as ClientId, a.Bezeichnung as ClientName
	From
		[10.0.68.27].[DMS_WOQOD].[dbo].[Auftraggeber] a

End

GO
/****** Object:  StoredProcedure [lomo].[GetAllProducts]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [lomo].[GetAllProducts]
As
Begin

	Select
		0 as ProductId, 'All' as ProductName

	union all

	--Select
	--	a.id as ProductId, a.Kurzbezeichnung as ProductName
	--From
	--	[10.0.68.27].[DMS_WOQOD].[dbo].[Produkt] a

	Select
		a.LomoProductId as ProductId, a.ERPName as ProductName
	From
		[LDO].[ordering].[MST_Products] a
	Where
		a.isActive = 1
		

End
GO
/****** Object:  StoredProcedure [lomo].[GetAllStatus]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [lomo].[GetAllStatus]
As
Begin

	Select
		0 as StatusId, 'All' as Status

	union all

	Select
		a.Id, a.Description 
	From
		[lomo].[MST_Status] a
	Where
		a.isActive = 1

End

GO
/****** Object:  StoredProcedure [lomo].[GetClients]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create Procedure [lomo].[GetClients]
As
Begin

	Select
		a.id, a.Nummer, a.Name1, a.Name2, a.MatchCode
	From
		[10.0.68.27].[DMS_WOQOD].dbo.Auftraggeber a

End

GO
/****** Object:  StoredProcedure [lomo].[GetFolderPath]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [lomo].[GetFolderPath]
(
	@MonthDate date
)
As
Begin

	Set 
		@MonthDate =  Cast(Cast(Year(@MonthDate) as varchar(4)) + '-' + CAST(MONTH(@MonthDate) as varchar(2)) + '-01' as date)

	if exists (select 1 from [lomo].[MST_Month_Folder] a where a.Datum = @MonthDate)
	Begin

		Select
			a.FolderPath
		From
			[lomo].[MST_Month_Folder] a
		Where
			a.Datum = @MonthDate

	End
	else
	Begin
		
		Declare @tmp table (folderPath hierarchyid)

		DECLARE @FirstSeqNum sql_variant,
				@LastSeqNum  sql_variant
 
			EXEC sys.sp_sequence_get_range
			@sequence_name = N'dbo.DirId'
		, @range_size = 1
		, @range_first_value = @FirstSeqNum OUTPUT
		, @range_last_value = @LastSeqNum OUTPUT

		Declare @MainFolderId HIERARCHYID
		Declare @SubDirectoryPath varchar(max)

		SELECT @SubDirectoryPath = CONCAT('/', CONVERT(VARCHAR(20),@FirstSeqNum) ,'.',
		CONVERT(VARCHAR(20),Convert(BIGINT,@FirstSeqNum)) ,'.',
		CONVERT(VARCHAR(20),@LastSeqNum) ,'/')
	
		INSERT INTO dbo.DocumentStore(name,path_locator,is_directory,is_archive)
		output inserted.path_locator into @tmp
		VALUES (Cast(@FirstSeqNum as nvarchar(max)), @SubDirectoryPath, 1, 0)

		Insert into
			[lomo].[MST_Month_Folder] (Datum, FolderPath, CreatedBy)
		output 
			inserted.FolderPath
		Select
			@MonthDate, a.folderPath, 5 -- System User
		From
			@tmp a

	End



End

GO
/****** Object:  StoredProcedure [lomo].[GetOrderLogs]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [lomo].[GetOrderLogs]
(
	@OrderId int
)
As
Begin
		
		Select
			a.OrderId, a.SiteNum, a.CustNum, a.MatchCode, a.CustomerName, a.Category, a.Client, a.OrderNum, a.LomCreatedOn, a.LomCreatedBy
			, a.Quantity, a.ProductId, a.Product, a.OrderStatus, a.LomModifiedOn, a.LomModifiedBy, a.TractorNumber, a.TrailorNumber, a.DriverName, a.ShiftId, a.ShiftDate
			, Cast(Case when b.Id is null then 0 else 1 end as bit) as UploadStatus, a.TourEnd, a.TranNo
			, Case when b.ResourceId is null then null else Cast(b.ResourceId as varchar(40)) end as ResourceId, b.Remark
			, c.FullName as ModifiedBy, b.ModifiedOn, a.DRNumber as DRNum
		From
			[lomo].[MST_Order_Documents] b
		Inner Join
			[lomo].[LOG_Order_Documents] a
		On
			a.OrderId = b.OrderId and a.TranNo = b.TranNo
		Inner Join
			[LDO].[dbo].[AspNetUsers] c
		On
			b.ModifiedBy = c.UId
		Where
			b.OrderId = @OrderId


End
GO
/****** Object:  StoredProcedure [lomo].[GetOrders]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [lomo].[GetOrders]
(
	@FromDate datetime = '2016-12-27 00:00:00.000'
	, @ToDate datetime = '2016-12-27 23:59:59.000'
	, @ShiftId smallint = 0
	, @ClientId int = 0
	, @ProductId int = 0
	, @StatusId tinyint = 0
	, @OrderNum varchar(max) = null
	, @DRNum varchar(max) = null
	, @PageId smallint = 1
	, @CustNum varchar(max) = null
	, @SiteNum varchar(max) = null
	, @NumberOfRows smallint = 20
)
As
Begin

		Declare @tmp table 
		(	
			[OrderId] [int] NULL, [SiteNum] [varchar](10) NULL, [CustNum] [varchar](10) NULL, [MatchCode] [varchar](15) NULL
			, [CustomerName] [varchar](200) NULL, [Category] [varchar](15) NULL, [Client] [varchar](200) NULL, [OrderNum] [varchar](15) NULL
			, [LomCreatedOn] [datetime] NULL, [LomCreatedBy] [varchar](15) NULL, [Quantity] [real] NULL, [ProductId] [int] NULL
			, [Product] [varchar](15) NULL, [OrderStatus] [int] NULL, [LomModifiedOn] [datetime] NULL, [LomModifiedBy] [varchar](15) NULL
			, [TractorNumber] [varchar](20) NULL, [TrailorNumber] [varchar](20) NULL, [DriverName] [varchar](max) NULL, ShiftId smallint, ShiftDate date
			, TourEnd datetime, DRNum varchar(15) null
		)
		
		Insert into
			@tmp (OrderId, SiteNum, CustNum, MatchCode, CustomerName, Category, Client, OrderNum, LomCreatedOn, LomCreatedBy, Quantity
					, ProductId, Product, OrderStatus, LomModifiedOn, LomModifiedBy, TractorNumber, TrailorNumber, DriverName, ShiftId, ShiftDate, TourEnd, DRNum)
		exec [10.0.68.27].[DMS_WOQOD].[dbo].[LDO_GetOrders] @FromDate, @ToDate, @ShiftId, @ClientId, @ProductId, @StatusId
					, @OrderNum, @DrNum, @PageId, @NumberOfRows, @CustNum, @SiteNum

		Select
			a.OrderId, a.SiteNum, a.CustNum, a.MatchCode, a.CustomerName, a.Category, a.Client, a.OrderNum, a.LomCreatedOn, a.LomCreatedBy
			, a.Quantity, a.ProductId, a.Product, a.OrderStatus, a.LomModifiedOn, a.LomModifiedBy, a.TractorNumber, a.TrailorNumber, a.DriverName, a.ShiftId, a.ShiftDate
			, Cast(Case when b.Id is null then 0 else 1 end as bit) as UploadStatus, a.TourEnd, a.DRNum
			, Case when b.ResourceId is null then null else Cast(b.ResourceId as varchar(40)) end as ResourceId, b.Remark
			, COUNT(1) over() as TotalRows
		From
			@tmp a
		Left Join
			[lomo].[MST_Order_Documents] b
		On
			a.OrderId = b.OrderId and b.isArchived = 0
		Where
			(@StatusId = 0 or (@StatusId = 1 and b.Id is null) or (@StatusId = 2 and b.Id is not null))
		Order By
			a.TourEnd desc
		Offset
			(@PageId - 1) * @NumberOfRows rows
		Fetch next 
			@NumberOfRows Rows only

End
GO
/****** Object:  StoredProcedure [lomo].[GetOrdersForExport]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [lomo].[GetOrdersForExport]
(
	@FromDate datetime = '2016-12-27 00:00:00.000'
	, @ToDate datetime = '2016-12-27 23:59:59.000'
	, @ShiftId smallint = 0
	, @ClientId int = 0
	, @ProductId int = 0
	, @StatusId tinyint = 0
	, @OrderNum varchar(max) = null
	, @DRNum varchar(max) = null
	, @CustNum varchar(max) = null
	, @SiteNum varchar(max) = null
	, @NumberOfRows smallint = 20
)
As
Begin

		Declare @tmp table 
		(	
			[OrderId] [int] NULL, [SiteNum] [varchar](10) NULL, [CustNum] [varchar](10) NULL, [MatchCode] [varchar](15) NULL
			, [CustomerName] [varchar](200) NULL, [Category] [varchar](15) NULL, [Client] [varchar](200) NULL, [OrderNum] [varchar](15) NULL
			, [LomCreatedOn] [datetime] NULL, [LomCreatedBy] [varchar](15) NULL, [Quantity] [real] NULL, [ProductId] [int] NULL
			, [Product] [varchar](15) NULL, [OrderStatus] [int] NULL, [LomModifiedOn] [datetime] NULL, [LomModifiedBy] [varchar](15) NULL
			, [TractorNumber] [varchar](20) NULL, [TrailorNumber] [varchar](20) NULL, [DriverName] [varchar](max) NULL, ShiftId smallint, ShiftDate date
			, TourEnd datetime, DRNum varchar(15) null
		)
		
		Insert into
			@tmp (OrderId, SiteNum, CustNum, MatchCode, CustomerName, Category, Client, OrderNum, LomCreatedOn, LomCreatedBy, Quantity
					, ProductId, Product, OrderStatus, LomModifiedOn, LomModifiedBy, TractorNumber, TrailorNumber, DriverName, ShiftId, ShiftDate, TourEnd, DRNum)
		exec [10.0.68.27].[DMS_WOQOD].[dbo].[LDO_GetOrders] @FromDate, @ToDate, @ShiftId, @ClientId, @ProductId, @StatusId
					, @OrderNum, @DrNum, 0, @NumberOfRows, @CustNum, @SiteNum

		Select
			a.OrderId, a.SiteNum, a.CustNum, a.MatchCode, a.CustomerName, a.Category, a.Client, a.OrderNum, a.LomCreatedOn, a.LomCreatedBy
			, a.Quantity, a.ProductId, a.Product, a.OrderStatus, a.LomModifiedOn, a.LomModifiedBy, a.TractorNumber, a.TrailorNumber, a.DriverName, a.ShiftId, a.ShiftDate
			, Cast(Case when b.Id is null then 'No' else 'Yes' end as varchar(5)) as UploadStatus, a.TourEnd, a.DRNum
			, Case when b.ResourceId is null then null else Cast(b.ResourceId as varchar(40)) end as ResourceId, b.Remark
			, COUNT(1) over() as TotalRows
		From
			@tmp a
		Left Join
			[lomo].[MST_Order_Documents] b
		On
			a.OrderId = b.OrderId and b.isArchived = 0
		Where
			(@StatusId = 0 or (@StatusId = 1 and b.Id is null) or (@StatusId = 2 and b.Id is not null))
		Order By
			a.TourEnd desc

End
GO
/****** Object:  StoredProcedure [lomo].[GetShifts]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [lomo].[GetShifts]
As
Begin

	Select
		a.ShiftId, a.ShiftName
	From
	(
		Select
			Cast(0 as int) as ShiftId, 'All' as ShiftName

		union all

		Select
			distinct a.Schicht as ShiftId, 'Shift - ' + Cast(a.Schicht as varchar(max)) as ShiftName
		From
			[10.0.68.27].[DMS_WOQOD].dbo.Disposition a
		Where
			a.Schicht in (1, 2, 3, 4, 5, 6)
	) a
	Order By
		a.ShiftId
	
End

GO
/****** Object:  StoredProcedure [lomo].[SaveDr]    Script Date: 1/10/2017 1:59:20 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [lomo].[SaveDr]
(
	@OrderId int
	, @SiteNum varchar(10) 
	, @CustNum  varchar(10) 
	, @MatchCode  varchar(15) 
	, @CustomerName  varchar(200) 
	, @Category varchar(15)
	, @Client varchar(50) 
	, @OrderNum varchar(15) 
	, @DRNum varchar(15) 
	, @LomCreatedOn datetime = null 
	, @LomCreatedBy varchar(15) 
	, @Quantity real 
	, @ProductId int 
	, @Product varchar(15) 
	, @OrderStatus int 
	, @LomModifiedOn datetime = null
	, @LomModifiedBy varchar(15) = null 
	, @TractorNumber varchar(10) 
	, @TrailorNumber varchar(10) 
	, @DriverName varchar(200) 
	, @ShiftId smallint 
	, @ShiftDate date 
	, @TourEnd datetime 
	, @CreatedBy int 
	, @Remark nvarchar(255)
	, @ResourceId uniqueidentifier
	, @DocCategoryId tinyint
)
As
Begin

	Begin Try

		Declare @TranNo varchar(20) = next value for [dbo].[TranDRNo] 

		if exists (select 1 from [lomo].[MST_Order_Documents] a where a.OrderId = @OrderId and a.DocCategoryId = @DocCategoryId)
		Begin

			Update a
			Set
				a.isArchived = 1
			From
				[lomo].[MST_Order_Documents] a
			Where
				a.OrderId = @OrderId and a.DocCategoryId = @DocCategoryId and a.isArchived = 0

		End

		Insert into [lomo].[LOG_Order_Documents]
			   ([OrderId], [SiteNum], [CustNum], [MatchCode], [CustomerName], [Category], [Client], [OrderNum], [DRNumber], [LomCreatedOn], [LomCreatedBy]
				, [Quantity], [ProductId], [Product], [OrderStatus], [LomModifiedOn], [LomModifiedBy], [TractorNumber], [TrailorNumber]
				, [DriverName], [ShiftId], [ShiftDate], [TourEnd], [TranNo], [CreatedBy])
		 Values
			   (@OrderId, @SiteNum, @CustNum, @MatchCode, @CustomerName, @Category, @Client, @OrderNum, @DRNum, @LomCreatedOn
				, @LomCreatedBy, @Quantity, @ProductId, @Product, @OrderStatus, @LomModifiedOn, @LomModifiedBy, @TractorNumber
				, @TrailorNumber, @DriverName, @ShiftId, @ShiftDate, @TourEnd, @TranNo, @CreatedBy)

		Insert into 
			[lomo].[MST_Order_Documents] (OrderId, OrderNum, DRNum, DocCategoryId, isArchived, Remark, ResourceId, TranNo, CreatedBy, ModifiedBy)
		Values
			(@OrderId, @OrderNum, @DRNum, @DocCategoryId, 0, @Remark, @ResourceId, @TranNo, @CreatedBy, @CreatedBy)

		Select CAST(1 as bit) as result

	End Try
	Begin Catch

		Declare @error nvarchar(max) = error_message()

		Select CAST(0 as bit) as result

	End Catch

	
	

End
GO
